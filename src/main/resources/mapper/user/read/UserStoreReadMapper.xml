<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tour.user.repository.read.UserStoreReadRepository">
    <select id="storeSearch" parameterType="java.util.Map" resultType="java.util.List">
        SELECT DISTINCT
               st.str_idx AS str_idx
             , asd.str_dt_name AS str_idx
             , (SELECT COUNT(*)
                FROM ad_review
                WHERE str_idx = st.str_idx ) AS str_review_cnt
        FROM ad_store st
            LEFT JOIN ad_store_detail asd ON st.str_idx = asd.str_idx
        WHERE asd.str_dt_type = #{lang} OR asd.str_dt_type = 'ko'
        AND asd.str_dt_name LIKE CONCAT('%',#{keyword},'%')
        GROUP BY st.str_idx, asd.str_dt_type
    </select>

    <select id="categoryList" parameterType="map" resultType="map">
        SELECT
            DISTINCT st.str_idx AS str_idx
                    , st.str_lat
                    , st.str_lng
                   , asd.str_dt_type AS str_dt_type
                   , asd.str_dt_name AS str_dt_name
                   , st.str_image AS str_image
                   , IFNULL(asd.str_dt_desc , '') AS str_dt_desc
                   , (SELECT COUNT(*)
                      FROM ad_review
                      WHERE str_idx = st.str_idx ) AS str_review_cnt
                   , 0 AS str_review_ave
                    , IFNULL(
                        (SELECT like_status
                         FROM ad_like
                         WHERE mb_idx = IFNULL(#{mb_idx}, '') and str_idx = st.str_idx), 'N') AS like_status
                    ,IFNULL(
                        ( SELECT fi.app_type FROM fcm_info fi WHERE fi.mb_idx = IFNULL(#{mb_idx}, '')), '') AS app_type
                    ,IFNULL(
                        (SELECT fi.app_ver FROM fcm_info fi WHERE fi.mb_idx = IFNULL(#{mb_idx}, '')), '') AS app_ver
        FROM ad_store st
                 LEFT JOIN ad_store_detail asd ON st.str_idx = asd.str_idx
                 LEFT JOIN ad_category ac ON st.str_category = ac.ct_idx
        WHERE ac.ct_parent = #{ct_parent}
          AND (asd.str_dt_type = 'ko' OR asd.str_dt_type = #{lang})
        GROUP BY st.str_idx, asd.str_dt_type
    </select>

    <select id="categoryDetail"  parameterType="map" resultType="map">
        SELECT DISTINCT
                    st.str_idx AS str_idx
                      , st.str_lat
                      , st.str_lng
                   , asd.str_dt_type AS str_dt_type
                   , asd.str_dt_name AS str_dt_name
                   , st.str_image AS str_image
                   , IFNULL(asd.str_dt_desc , '') AS str_dt_desc
                   , (SELECT COUNT(*)
                      FROM ad_review
                      WHERE str_idx = st.str_idx ) AS str_review_cnt
                   , 0 AS str_review_ave
                   , IFNULL(
                        (SELECT like_status
                         FROM ad_like
                         WHERE mb_idx = IFNULL(#{mb_idx}, '') and str_idx = st.str_idx), 'N') AS like_status
                      ,IFNULL(
                ( SELECT fi.app_type FROM fcm_info fi WHERE fi.mb_idx = IFNULL(#{mb_idx}, '')), '') AS app_type
                      ,IFNULL(
                (SELECT fi.app_ver FROM fcm_info fi WHERE fi.mb_idx = IFNULL(#{mb_idx}, '')), '') AS app_ver
        FROM ad_store st
                 LEFT JOIN ad_store_detail asd ON st.str_idx = asd.str_idx
        WHERE st.str_category = #{str_category}
          AND (asd.str_dt_type = 'ko' OR asd.str_dt_type = #{lang})
        GROUP BY st.str_idx, asd.str_dt_type
    </select>

    <select id="storeDetail" parameterType="map" resultType="java.util.Map">
        SELECT DISTINCT
            st.str_idx
            , st.str_lat
            , st.str_lng
            , st.str_image
            , st.str_week_s_time
            , st.str_week_e_time
            , st.str_phone
            , st.str_category
            , asd.str_dt_name
            , asd.str_dt_type
            , IFNULL(asd.str_dt_address , '') AS str_dt_address
            , IFNULL(asd.str_dt_address_dt , '') AS str_dt_address_dt
            , IFNULL(asd.str_dt_desc , '') AS str_dt_desc
            , (SELECT COUNT(*)
               FROM ad_review
               WHERE str_idx = st.str_idx ) AS str_review_cnt
            , 0 AS str_review_ave
            , IFNULL(
                (SELECT like_status
                FROM ad_like
                WHERE mb_idx = IFNULL(#{mb_idx}, '') and str_idx = st.str_idx GROUP BY mb_idx), 'N') AS like_status
            ,IFNULL(
                ( SELECT fi.app_type FROM fcm_info fi WHERE fi.mb_idx = IFNULL(#{mb_idx}, '')), '') AS app_type
            ,IFNULL(
                (SELECT fi.app_ver FROM fcm_info fi WHERE fi.mb_idx = IFNULL(#{mb_idx}, '')), '') AS app_ver
		FROM ad_store st
 			LEFT JOIN ad_store_detail asd
			ON st.str_idx = asd.str_idx
		WHERE st.str_idx = #{str_idx}
		AND (asd.str_dt_type = 'ko' OR asd.str_dt_type = #{lang})
        GROUP BY st.str_idx, asd.str_dt_type
    </select>

    <select id="strReviewRead" parameterType="map" resultType="list">
        SELECT
            av.str_idx
            , av.mb_idx
            , av.rv_type
            , av.rv_anonym
            , av.rv_blind
            , av.rv_contents
            , av.rv_reg_date
            , av.rv_reg_time
            , IFNULL(av.rv_reply , '') as
        FROM ad_review av
        WHERE str_idx = #{str_idx}
    </select>


</mapper>